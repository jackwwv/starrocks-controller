package modifyConfig 
import (
    "fmt"
    "sr-controller/module"
    "sr-controller/sr-utl"
)

func ModifyFeClusterConfig() {

    var infoMess string

    for i := 0; i < len(module.GYamlConf.FeServers); i++ {

        // copy fe config file
	tmpFeHost := module.GYamlConf.FeServers[i].Host
	tmpFeQueryPort := module.GYamlConf.FeServers[i].QueryPort
	tmpConfFile := fmt.Sprintf("%s/tmp/fe.conf-%s-%d", module.GSRCtlRoot, tmpFeHost, tmpFeQueryPort)

	err := copyFeConfigFile(tmpConfFile)
	if err != nil {
	    infoMess = fmt.Sprintf("Error in modifing fe cluster configuration. Copy configuration file failed [tmpConfFile = %s]", tmpConfFile)
	    utl.Log("ERROR", infoMess)
	    panic(err)
	}

	// append new config into tmp configuration file
	// add network priority config
	tmpConfigKey := "priority_networks"
	tmpConfigValue := module.GYamlConf.FeServers[i].PriorityNetworks
	appendFeConfig(tmpConfFile, tmpConfigKey, tmpConfigValue)


        // distribute tmp fe configuration file
	tmpUser := module.GYamlConf.Global.User
	tmpKeyFile := "/root/.ssh/id_rsa"
	tmpFeSshPort := module.GYamlConf.FeServers[i].SshPort
        tmpTargetFeConfPath := module.GYamlConf.FeServers[i].DeployDir + "/conf/fe.conf"
        utl.UploadFile(tmpUser, tmpKeyFile, tmpFeHost, tmpFeSshPort, tmpConfFile, tmpTargetFeConfPath)

    }
    /*
    configFile := fmt.Sprintf("%s/tmp/fe.conf-%s", module.GSRCtlRoot, "test")
    err := utl.AppendConfig(configFile, "XXXXXXXXXXX")
    if err!= nil {
        infoMess = fmt.Sprintf("Error in modifying fe cluster config")
	utl.Log("ERROR", infoMess)
	panic(err)
    }
    */
}

func copyFeConfigFile(targetFile string) (err error){

    var infoMess string

    sourceFile := fmt.Sprintf("%s/download/StarRocks-2.0.1/fe/conf/fe.conf", module.GSRCtlRoot)
    fileByte, err := utl.CopyFile(sourceFile, targetFile)
    if err != nil || fileByte == 0 {
        infoMess = fmt.Sprintf("Error in copy fe config file, [sourceFile = %s, targetFile = %s, fileByte = %d, error = %v]", sourceFile, targetFile, fileByte, err)
	utl.Log("ERROR", infoMess)
	return err
    }

    return nil

}

func appendFeConfig(configFile string, configKey string, configValue string) {

    var infoMess string

    err := utl.AppendConfig(configFile, configKey, configValue)
    if err != nil {
        infoMess = fmt.Sprintf("Error in append new configuration to tmp config file [configFile = %s, configKey = %s, configValue = %s]", configFile, configKey, configValue)
        utl.Log("ERROR", infoMess)
        panic(err)
    }
    infoMess = fmt.Sprintf("Append new configuration to tmp config file [configFile = %s, configKey = %s, configValue = %s]", configFile, configKey, configValue)
    utl.Log("INFO", infoMess)

}


